<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Painel - Simples Nacional (JSON compatível)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- seu style.css externo (mantém layout principal) -->
  <link rel="stylesheet" href="style.css">
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- fallback CSS mínimo para garantir que não quebre -->
  <style>
    /* Fallback mínimos — serão sobrescritos pelo style.css se ele existir */
    :root { --accent: #007BFF; }
    body { font-family: "Segoe UI", Arial, sans-serif; margin:0; background:#f7f9fb; color:#222; }
    header { background:var(--accent); color:#fff; padding:12px 0; text-align:center; position:fixed; left:0; right:0; top:0; z-index:10; }
    main { padding:72px 12px 80px; display:flex; justify-content:center; }
    .wrap { width:100%; max-width:980px; background:#fff; border-radius:10px; padding:14px; box-shadow:0 6px 16px rgba(0,0,0,0.06); }
    .grid { display:grid; grid-template-columns:2fr 1fr; gap:12px; }
    @media (max-width:820px){ .grid { grid-template-columns:1fr; } }
    .card { background:#fbfcfe; border:1px solid #e6eef9; border-radius:8px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .label { display:flex; align-items:center; gap:8px; font-weight:600; color:#333; }
    select, input { font-size:13px; padding:6px; border:1px solid #d7e3f6; border-radius:6px; outline:none; }
    input.currency { text-align:right; }
    .hint { font-size:12px; color:#555; margin-top:4px; }
    .action { display:flex; justify-content:center; margin-top:12px; }
    .json-preview { margin-top:10px; background:#0f1720; color:#e6f0ff; padding:10px; border-radius:6px; font-family:monospace; font-size:13px; overflow:auto; max-height:180px; }
    .dynamic-block { margin-top:8px; padding:8px; background:#fff; border:1px dashed #e0e7f1; border-radius:6px; }

    /* meses: duas colunas, tag à esquerda dentro do campo */
    .months-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    @media(max-width:600px) { .months-grid { grid-template-columns:1fr; } }
    .month-cell { display:flex; flex-direction:column; gap:4px; }
    .month-wrapper { position:relative; width:100%; }
    .month-wrapper input { width:100%; box-sizing:border-box; padding-left:74px; text-align:right; }
    .month-tag { position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:12px; color:#444; background:#fff; padding:4px 6px; border-radius:6px; border:1px solid rgba(0,0,0,0.04); pointer-events:none; white-space:nowrap; }
    .error-msg { color:#c0392b; font-size:12px; margin-top:4px; font-style:italic; }
  </style>
</head>
<body>
  <header><h1><i data-lucide="calculator"></i> Painel de Cálculo — JSON compatível</h1></header>

  <main>
    <div class="wrap">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong style="color:var(--accent)">Entrada de Dados</strong>
        <span style="font-size:12px;color:#666">Preencha e clique em "Verificar e Calcular"</span>
      </div>

      <div class="grid">
        <!-- esquerda -->
        <div class="card" id="left-card">
          <div class="label"><i data-lucide="layers"></i> Qual anexo?</div>
          <select id="anexo">
            <option value="">-- selecione --</option>
            <option>Anexo I - Comércio</option>
            <option>Anexo II - Indústria</option>
            <option>Anexo III - Serviço</option>
            <option>Anexo IV - Serviço</option>
            <option>Anexo V - Serviço</option>
          </select>

          <div class="label" style="margin-top:6px"><i data-lucide="activity"></i> Você sabe o RBT da sua PJ?</div>
          <select id="rbt-conhece">
            <option value="">-- selecione --</option>
            <option>Sim</option>
            <option>Não</option>
          </select>

          <div id="rbt-dynamic-area"></div>
        </div>

        <!-- direita -->
        <div class="card content-right">
          <div class="label"><i data-lucide="file-text"></i> Faturamento para cálculo</div>
          <input id="faturamento" class="currency" placeholder="R$ —" />

          <div class="label" style="margin-top:8px"><i data-lucide="globe"></i> É exportação de serviços?</div>
          <select id="exportacao">
            <option value="">-- selecione --</option>
            <option>Sim</option>
            <option>Não</option>
          </select>
        </div>
      </div>

      <div class="action">
        <button id="btnEnviar"><i data-lucide="check-circle"></i> Verificar e Calcular</button>
      </div>

      <div class="errors" id="errors" aria-live="polite"></div>

      <div id="previewWrapper" style="display:none">
        <div style="margin-top:10px;font-size:13px;color:#333"><strong>JSON a ser enviado:</strong></div>
        <pre id="jsonPreview" class="json-preview"></pre>
      </div>
    </div>
  </main>

  <footer style="position:fixed;bottom:0;left:0;right:0;height:48px;background:#f1f3f6;border-top:1px solid #e6eef5;display:flex;align-items:center;justify-content:center;font-size:13px">
    Simples Nacional • v2.2 • Desenvolvido por Edinaldo P.S.
  </footer>

  <script>
    // inicializa icons
    lucide.createIcons();

    // mapeamento
    const anexoMap = {
      "Anexo I - Comércio": 1,
      "Anexo II - Indústria": 2,
      "Anexo III - Serviço": 3,
      "Anexo IV - Serviço": 4,
      "Anexo V - Serviço": 5
    };

    // elementos DOM
    const rbtConheceSelect = document.getElementById('rbt-conhece');
    const rbtDynamicArea = document.getElementById('rbt-dynamic-area');
    const faturamentoInput = document.getElementById('faturamento');
    const exportacaoSelect = document.getElementById('exportacao');
    const btnEnviar = document.getElementById('btnEnviar');
    const anexoSelect = document.getElementById('anexo');
    const errorsDiv = document.getElementById('errors');
    const previewWrapper = document.getElementById('previewWrapper');
    const jsonPreview = document.getElementById('jsonPreview');

    // campo RBT (reutilizável, sempre criado mas inserido no DOM apenas quando necessário)
    const rbtInput = document.createElement('input');
    rbtInput.className = 'currency';
    rbtInput.placeholder = 'R$ —';
    attachCurrencyBehaviorMinimal(rbtInput);

    // evento Sim/Não para RBT conhecido
    rbtConheceSelect.addEventListener('change', () => {
      rbtDynamicArea.innerHTML = '';
      errorsDiv.textContent = '';

      if (rbtConheceSelect.value === 'Sim') {
        // mostra campo RBT manual
        const label = document.createElement('div');
        label.className = 'label';
        label.innerHTML = '<i data-lucide="coins"></i> Informe o RBT';
        rbtDynamicArea.appendChild(label);
        rbtDynamicArea.appendChild(rbtInput);
        lucide.createIcons();
      } else if (rbtConheceSelect.value === 'Não') {
        // mostra bloco de data -> confirma -> gera meses automaticamente
        const block = document.createElement('div');
        block.className = 'dynamic-block';

        const label = document.createElement('div');
        label.className = 'label';
        label.innerHTML = '<i data-lucide="calendar"></i> Data de abertura da PJ';

        const inputDate = document.createElement('input');
        inputDate.type = 'date';

        // limitar visualmente a seleção (sempre validar ao confirmar)
        const hoje = new Date();
        const hojeStr = hoje.toISOString().split('T')[0];
        inputDate.max = hojeStr;

        const hint = document.createElement('div');
        hint.className = 'hint';
        hint.textContent = 'Se ainda não tem PJ aberta, coloque a data de hoje.';

        const btn = document.createElement('button');
        btn.textContent = 'Confirmar data';

        const monthsArea = document.createElement('div');
        monthsArea.style.marginTop = '10px';

        block.append(label, inputDate, btn, hint, monthsArea);
        rbtDynamicArea.appendChild(block);
        lucide.createIcons();

        btn.addEventListener('click', () => {
          monthsArea.innerHTML = '';
          errorsDiv.textContent = '';

          if (!inputDate.value) {
            alert('Informe a data de abertura.');
            return;
          }

          // validação contra datas futuras (confirmação)
          if (inputDate.value > hojeStr) {
            hint.textContent = 'Datas futuras não são permitidas. Corrija a data.';
            hint.classList.add('error-msg');
            inputDate.disabled = false;
            btn.disabled = false;
            return;
          }

          // ok - ocultar hint
          hint.style.display = 'none';

          // calcula quantos meses e startDate
          const abertura = new Date(inputDate.value);
          const info = computeMonthsAndStart(abertura);
          const meses = info.months;
          const startDate = info.startDate;
          const hojeDate = new Date();

          // grid de meses (duas colunas)
          const grid = document.createElement('div');
          grid.className = 'months-grid';
          const inputs = [];

          for (let i = 0; i < meses; i++) {
            const d = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
            // ultimo mes completo (mês anterior ao atual)
            const lastCompleted = new Date(hojeDate.getFullYear(), hojeDate.getMonth() - 1, 1);
            if (d > lastCompleted) break;

            const cell = document.createElement('div');
            cell.className = 'month-cell';

            const wrapper = document.createElement('div');
            wrapper.className = 'month-wrapper';

            const inp = document.createElement('input');
            inp.type = 'text';
            inp.className = 'currency month-input';
            inp.placeholder = 'R$ —';
            attachCurrencyBehaviorMinimal(inp);

            const tag = document.createElement('div');
            tag.className = 'month-tag';
            tag.textContent = abreviarMes(d);

            wrapper.appendChild(tag);
            wrapper.appendChild(inp);
            cell.appendChild(wrapper);
            grid.appendChild(cell);
            inputs.push(inp);
          }

          monthsArea.appendChild(grid);
          lucide.createIcons();

          // cálculo automático: quando todos os inputs tiverem valor (0 é válido)
          function tryAutoCalculate() {
            if (inputs.length === 0) return;
            const allFilled = inputs.every(i => i.getNumericValue() !== null);
            if (!allFilled) return;
            const total = inputs.reduce((s, i) => s + i.getNumericValue(), 0);
            const media = total / inputs.length;
            const rbtCalc = media * 12;
            rbtInput.setNumericValue(rbtCalc);
          }

          // escuta eventos nos inputs: blur, input, paste
          inputs.forEach(i => {
            i.addEventListener('blur', tryAutoCalculate);
            i.addEventListener('input', tryAutoCalculate);
            i.addEventListener('paste', () => setTimeout(tryAutoCalculate, 50));
          });

          // tentativa imediata (caso já tenham valor)
          tryAutoCalculate();

          // travar data (confirmada)
          btn.disabled = true;
          inputDate.disabled = true;
        });
      } else {
        // vazio — limpa área dinâmica
        rbtDynamicArea.innerHTML = '';
      }
    });

    // inicializar outros campos
    attachCurrencyBehaviorMinimal(faturamentoInput);

    // botão verificar e montar JSON final
    btnEnviar.addEventListener('click', () => {
      errorsDiv.textContent = '';
      previewWrapper.style.display = 'none';

      const anexo = anexoMap[anexoSelect.value];
      const rbtVal = rbtInput.getNumericValue();
      const faturVal = faturamentoInput.getNumericValue();
      const exportVal = exportacaoSelect.value;

      const faltam = [];
      if (!anexo) faltam.push('anexo');
      if (rbtVal === null) faltam.push('RBT');
      if (faturVal === null) faltam.push('faturamento');
      if (!exportVal) faltam.push('exportação');

      if (faltam.length) {
        errorsDiv.textContent = 'Preencha: ' + faltam.join(', ');
        return;
      }

      const finalObj = {
        anexo,
        rbt: Number(rbtVal.toFixed(2)),
        faturamento: Number(faturVal.toFixed(2)),
        exportacao_servico: exportVal === 'Sim' ? 1 : 0
      };

      jsonPreview.textContent = JSON.stringify(finalObj, null, 2);
      previewWrapper.style.display = 'block';
    });

    /* ---------------- Helpers ---------------- */

    function attachCurrencyBehaviorMinimal(inp) {
      let cents = 0, touched = false;
      function render() {
        if (!touched && cents === 0) { inp.value = ''; return; }
        inp.value = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(cents/100);
      }
      inp.addEventListener('keydown', e => {
        if (/\d/.test(e.key)) { e.preventDefault(); touched = true; cents = cents * 10 + +e.key; render(); }
        else if (e.key === 'Backspace') { e.preventDefault(); touched = true; cents = Math.floor(cents / 10); render(); }
        else if (e.key === 'Delete') { e.preventDefault(); touched = true; cents = 0; render(); }
        else if (!['Tab','ArrowLeft','ArrowRight','Enter'].includes(e.key)) e.preventDefault();
      });
      inp.addEventListener('blur', render);
      inp.addEventListener('paste', (ev) => {
        ev.preventDefault();
        const txt = (ev.clipboardData || window.clipboardData).getData('text') || '';
        const n = parseToNumber(txt);
        if (n !== null) { cents = Math.round(n * 100); touched = true; render(); }
      });
      inp.getNumericValue = () => touched ? cents / 100 : null;
      inp.setNumericValue = num => { cents = Math.round(num * 100); touched = true; render(); };
      render();
    }

    function parseToNumber(s) {
      if (s === null || s === undefined) return null;
      let t = String(s).trim();
      if (!t) return null;
      t = t.replace(/\s/g,'').replace(/R\$/gi,'');
      const comma = t.indexOf(',');
      const dot = t.indexOf('.');
      if (dot !== -1 && comma !== -1) t = t.replace(/\./g,'').replace(',','.');
      else if (comma !== -1 && dot === -1) t = t.replace(',','.');
      t = t.replace(/[^0-9\.\-]/g,'');
      const n = Number(t);
      return isNaN(n) ? null : n;
    }

    function abreviarMes(dateObj) {
      const meses = ["Jan.", "Fev.", "Mar.", "Abr.", "Mai.", "Jun.", "Jul.", "Ago.", "Set.", "Out.", "Nov.", "Dez."];
      const nome = meses[dateObj.getMonth()];
      return `${nome} ${dateObj.getFullYear()}`;
    }

    function computeMonthsAndStart(abertura) {
      const hoje = new Date();
      let orig = (hoje.getFullYear() - abertura.getFullYear()) * 12 + (hoje.getMonth() - abertura.getMonth());
      if (hoje.getDate() < abertura.getDate()) orig--;
      if (orig < 1) orig = 1;
      const months = Math.min(orig, 12);
      const rawDiff = (hoje.getFullYear() - abertura.getFullYear()) * 12 + (hoje.getMonth() - abertura.getMonth());
      let startDate;
      if (rawDiff > 12) {
        const lastCompleted = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
        startDate = new Date(lastCompleted.getFullYear(), lastCompleted.getMonth() - (months - 1), 1);
      } else {
        startDate = new Date(abertura.getFullYear(), abertura.getMonth(), 1);
      }
      return { months, startDate };
    }
  </script>
</body>
</html>
